# å°ç»„ä»¶æŒ‰é’®åŠ¨ç”»é—®é¢˜æ ¹æœ¬åŸå› åˆ†æä¸ä¿®å¤

## é—®é¢˜ç°è±¡å›é¡¾

**ç”¨æˆ·æè¿°**ï¼š
1. æ­£å¸¸åˆ·æ–°æ˜¯é¡ºæ—¶é’ˆè½¬çš„
2. ä½†æœ‰æ—¶å€™æŒ‰åˆ‡æ¢æŒ‰é’®ï¼ˆæ²¡æœ‰æŒ‰åˆ·æ–°ï¼‰ï¼Œåˆ·æ–°æŒ‰é’®å´è‡ªå·±é€†æ—¶é’ˆè½¬äº†
3. åˆ‡æ¢æŒ‰é’®å˜å¤§ä¹‹åæ²¡æœ‰æ¢å¤åˆ°åŸå§‹å¤§å°

## æ·±åº¦æ ¹å› åˆ†æ

ç»è¿‡å®Œæ•´çš„æ‰§è¡Œæµç¨‹è¿½è¸ªï¼Œå‘ç°äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š

### ğŸ” æ‰§è¡Œæµç¨‹åˆ†æ

```
1. ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢æŒ‰é’®
   â†“
2. ToggleScholarIntent.perform() æ‰§è¡Œ
   - è®¾ç½® ScholarSwitched = true
   - âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ RefreshTriggered æ ‡è®°
   â†“
3. WidgetCenter.shared.reloadAllTimelines() 
   â†“
4. getTimeline() åˆ›å»ºæ–°çš„ entry (entry.date å˜äº†)
   â†“
5. SmallWidgetView é‡æ–°æ¸²æŸ“
   - onAppear() è§¦å‘
   - onChange(of: entry.date) è§¦å‘ âš ï¸ å…³é”®ï¼
   â†“
6. checkAndTriggerAnimations() æ‰§è¡Œ
   - æ£€æŸ¥ ScholarSwitched = true âœ… è§¦å‘åˆ‡æ¢åŠ¨ç”»  
   - æ£€æŸ¥ RefreshTriggered = ? âš ï¸ å¦‚æœå­˜åœ¨å†å²æ ‡è®°ï¼Œæ„å¤–è§¦å‘åˆ·æ–°åŠ¨ç”»
```

### ğŸ› æ ¹æœ¬é—®é¢˜

1. **åŠ¨ç”»æ ‡è®°æ®‹ç•™**ï¼šåˆ·æ–°æ“ä½œç•™ä¸‹çš„ `RefreshTriggered = true` æ²¡æœ‰è¢«åŠæ—¶æ¸…é™¤
2. **å°ç»„ä»¶é‡æ–°åŠ è½½è§¦å‘æ£€æŸ¥**ï¼šæ¯æ¬¡ `entry.date` å˜åŒ–éƒ½ä¼šæ£€æŸ¥æ‰€æœ‰åŠ¨ç”»æ ‡è®°
3. **äº¤å‰è§¦å‘**ï¼šåˆ‡æ¢Intentæ²¡æœ‰æ¸…é™¤åˆ·æ–°æ ‡è®°ï¼Œå¯¼è‡´æ„å¤–çš„åŠ¨ç”»æ‰§è¡Œ
4. **è§’åº¦è®¡ç®—é—®é¢˜**ï¼šåˆ·æ–°åŠ¨ç”»çš„è§’åº¦å¤„ç†åœ¨çŠ¶æ€é‡å»ºåå¯èƒ½å¯¼è‡´é€†æ—¶é’ˆæ—‹è½¬

## ğŸ”§ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. Intentäº’æ–¥æ¸…ç†

**ToggleScholarIntent ä¿®å¤**ï¼š
```swift
// è®¾ç½®åˆ‡æ¢æ ‡è®°ï¼ŒåŒæ—¶æ¸…é™¤å¯èƒ½å­˜åœ¨çš„åˆ·æ–°æ ‡è®°
if let appGroupDefaults = UserDefaults(suiteName: appGroupIdentifier) {
    appGroupDefaults.set(nextScholar.id, forKey: "SelectedWidgetScholarId")
    appGroupDefaults.set(nextScholar.displayName, forKey: "SelectedWidgetScholarName")
    appGroupDefaults.set(true, forKey: "ScholarSwitched")
    // å…³é”®ä¿®å¤ï¼šæ¸…é™¤å¯èƒ½æ®‹ç•™çš„åˆ·æ–°æ ‡è®°
    appGroupDefaults.removeObject(forKey: "RefreshTriggered")
    appGroupDefaults.synchronize()
}
```

**QuickRefreshIntent ä¿®å¤**ï¼š
```swift
// è®¾ç½®åˆ·æ–°æ ‡è®°ï¼ŒåŒæ—¶æ¸…é™¤å¯èƒ½å­˜åœ¨çš„åˆ‡æ¢æ ‡è®°
if let appGroupDefaults = UserDefaults(suiteName: appGroupIdentifier) {
    appGroupDefaults.set(timestamp, forKey: "LastRefreshTime")
    appGroupDefaults.set(true, forKey: "RefreshTriggered")
    // å…³é”®ä¿®å¤ï¼šæ¸…é™¤å¯èƒ½æ®‹ç•™çš„åˆ‡æ¢æ ‡è®°
    appGroupDefaults.removeObject(forKey: "ScholarSwitched")
    appGroupDefaults.synchronize()
}
```

### 2. åˆ·æ–°åŠ¨ç”»è§’åº¦ä¿®å¤

**é—®é¢˜**ï¼šçŠ¶æ€é‡å»ºåè§’åº¦é‡ç½®ï¼Œå¯¼è‡´åŠ¨ç”»æ–¹å‘å¼‚å¸¸

**ä¿®å¤**ï¼šä½¿ç”¨å¢é‡æ—‹è½¬ï¼Œç¡®ä¿å§‹ç»ˆé¡ºæ—¶é’ˆ
```swift
private func performRefreshAnimation() {
    guard !isRefreshing else { return }
    
    isRefreshing = true
    
    // è·å–å½“å‰è§’åº¦ï¼Œä¿è¯é¡ºæ—¶é’ˆå¢é‡æ—‹è½¬
    let startRotation = refreshRotation.truncatingRemainder(dividingBy: 360)
    let targetRotation = startRotation + 360
    
    print("ğŸ”„ [Widget] å¼€å§‹åˆ·æ–°åŠ¨ç”»ï¼Œä»è§’åº¦: \(startRotation) åˆ° \(targetRotation)")
    
    withAnimation(.easeInOut(duration: 0.8)) {
        refreshRotation = targetRotation
    }
    
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.8) {
        // åŠ¨ç”»å®Œæˆåæ ‡å‡†åŒ–è§’åº¦åˆ°0-360èŒƒå›´
        self.refreshRotation = self.refreshRotation.truncatingRemainder(dividingBy: 360)
        self.isRefreshing = false
        print("ğŸ”„ [Widget] åˆ·æ–°åŠ¨ç”»å®Œæˆï¼Œæœ€ç»ˆè§’åº¦: \(self.refreshRotation)")
    }
}
```

### 3. åˆ‡æ¢åŠ¨ç”»æ—¶åºä¼˜åŒ–

ä¿æŒåŸæœ‰çš„åˆ‡æ¢åŠ¨ç”»é€»è¾‘ï¼Œç¡®ä¿ï¼š
- 0.3ç§’æ”¾å¤§åˆ°1.2å€
- 0.3ç§’æ¢å¤åˆ°1.0å€  
- 0.3ç§’ç¼“å†²æ—¶é—´é‡ç½®çŠ¶æ€

## âœ… ä¿®å¤æ•ˆæœ

### é¢„æœŸè¡Œä¸ºï¼š

1. **æŒ‰åˆ‡æ¢æŒ‰é’®**ï¼š
   - âœ… åªè§¦å‘åˆ‡æ¢åŠ¨ç”»ï¼ˆç¼©æ”¾æ•ˆæœï¼‰
   - âœ… åˆ‡æ¢æŒ‰é’®æ­£å¸¸æ¢å¤åŸå§‹å¤§å°
   - âœ… ç»ä¸ä¼šè§¦å‘åˆ·æ–°æŒ‰é’®æ—‹è½¬

2. **æŒ‰åˆ·æ–°æŒ‰é’®**ï¼š
   - âœ… åªè§¦å‘åˆ·æ–°åŠ¨ç”»ï¼ˆé¡ºæ—¶é’ˆæ—‹è½¬360åº¦ï¼‰
   - âœ… å§‹ç»ˆä»å½“å‰è§’åº¦å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬
   - âœ… ç»ä¸ä¼šè§¦å‘åˆ‡æ¢æŒ‰é’®ç¼©æ”¾

3. **äº¤äº’ç‹¬ç«‹æ€§**ï¼š
   - âœ… ä¸¤ä¸ªæŒ‰é’®åŠŸèƒ½å®Œå…¨ç‹¬ç«‹
   - âœ… æ²¡æœ‰æ„å¤–çš„äº¤å‰è§¦å‘
   - âœ… åŠ¨ç”»æ–¹å‘å’Œæ•ˆæœä¿æŒä¸€è‡´

## ğŸ§ª è°ƒè¯•éªŒè¯

### å…³é”®æ—¥å¿—ç›‘æ§ï¼š

```
ğŸ¯ [Intent] åˆ‡æ¢æ ‡è®°å·²è®¾ç½®: ScholarSwitched = true, åˆ·æ–°æ ‡è®°å·²æ¸…é™¤
ğŸ”„ [Intent] åˆ·æ–°æ ‡è®°å·²è®¾ç½®: RefreshTriggered = true, åˆ‡æ¢æ ‡è®°å·²æ¸…é™¤
ğŸ¯ [Widget] å¼€å§‹åˆ‡æ¢åŠ¨ç”»ï¼Œå½“å‰scale: 1.0
ğŸ”„ [Widget] å¼€å§‹åˆ·æ–°åŠ¨ç”»ï¼Œä»è§’åº¦: 0.0 åˆ° 360.0
```

### æµ‹è¯•åœºæ™¯ï¼š

1. **è¿ç»­å¿«é€Ÿæ“ä½œ**ï¼šå¿«é€Ÿç‚¹å‡»åˆ‡æ¢â†’åˆ·æ–°â†’åˆ‡æ¢ï¼ŒéªŒè¯æ— äº¤å‰å½±å“
2. **ç³»ç»Ÿé‡è½½**ï¼šæ¨¡æ‹Ÿå°ç»„ä»¶é‡æ–°åŠ è½½ï¼ŒéªŒè¯çŠ¶æ€æ­£ç¡®æ¢å¤
3. **è§’åº¦è¾¹ç•Œ**ï¼šåœ¨ä¸åŒè§’åº¦çŠ¶æ€ä¸‹è§¦å‘åˆ·æ–°ï¼ŒéªŒè¯å§‹ç»ˆé¡ºæ—¶é’ˆ

## æ€»ç»“

é€šè¿‡æ·±å…¥çš„æ‰§è¡Œæµç¨‹åˆ†æï¼Œæ‰¾åˆ°äº†é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯**åŠ¨ç”»æ ‡è®°çš„äº¤å‰æ®‹ç•™**å’Œ**å°ç»„ä»¶çŠ¶æ€é‡å»ºæ—¶çš„è§’åº¦å¤„ç†é—®é¢˜**ã€‚

ä¿®å¤æ–¹æ¡ˆé‡‡ç”¨äº†**Intentäº’æ–¥æ¸…ç†**å’Œ**å¢é‡è§’åº¦æ—‹è½¬**çš„ç­–ç•¥ï¼Œç¡®ä¿ï¼š
- æ¯ä¸ªIntentåªè®¾ç½®è‡ªå·±çš„æ ‡è®°ï¼ŒåŒæ—¶æ¸…é™¤å¯¹æ–¹çš„æ ‡è®°
- åˆ·æ–°åŠ¨ç”»å§‹ç»ˆåŸºäºå½“å‰è§’åº¦è¿›è¡Œå¢é‡æ—‹è½¬
- å½»åº•é¿å…äº†äº¤å‰è§¦å‘å’Œè§’åº¦è®¡ç®—å¼‚å¸¸

ç°åœ¨å°ç»„ä»¶æŒ‰é’®åº”è¯¥èƒ½å¤Ÿæä¾›å®Œå…¨ç‹¬ç«‹ã€ç¨³å®šçš„äº¤äº’ä½“éªŒï¼