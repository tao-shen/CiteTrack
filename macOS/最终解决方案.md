# 🎯 最终解决方案：修复 App Sandbox 验证失败

## 问题分析

您遇到的错误表明：
1. ✅ 修复脚本已成功运行（所有组件都已签名）
2. ❌ 但 App Store 验证仍然失败

**可能的原因**：
- 修复脚本运行后，Archive 被重新打包成 `.pkg` 时签名被覆盖
- 或者修复脚本运行后，没有使用修复后的 Archive 提交

## ✅ 解决方案

### 方法 1：确保正确的操作顺序（推荐）

**关键**：必须在 Archive 完成后、提交前运行修复脚本。

#### 步骤：

1. **在 Xcode 中 Archive**
   ```
   Product → Archive
   ```

2. **等待 Archive 完成**
   - 不要立即点击 "Distribute App"
   - 等待 Organizer 窗口自动打开

3. **运行修复脚本**（在 Terminal 中）
   ```bash
   cd /Users/tao.shen/google_scholar_plugin/macOS
   ./scripts/fix_archive_entitlements.sh
   ```

4. **验证脚本输出**
   - 应该看到所有 ✅ 消息
   - 确认所有组件都已签名

5. **在 Xcode Organizer 中提交**
   - 刷新 Organizer（关闭并重新打开，或按 Cmd+R）
   - 选择修复后的 Archive
   - 点击 **Distribute App** → **App Store Connect**

---

### 方法 2：如果方法 1 仍然失败

如果按照正确顺序操作后仍然失败，可能是 Xcode 在打包 `.pkg` 时重新签名覆盖了我们的修改。

**解决方案**：在 Xcode 的 Archive 设置中禁用自动重新签名。

#### 步骤：

1. **打开 Xcode 项目设置**
   - 选择项目 → **CiteTrack** target → **Build Settings**

2. **搜索 "Code Signing"**
   - 找到 **Code Signing Identity**
   - 确保选择了正确的证书（不是 "Automatic"）

3. **在 Archive 时使用手动签名**
   - 在 **Signing & Capabilities** 中
   - 取消勾选 **"Automatically manage signing"**（如果可能）
   - 或确保使用 **"Developer ID Application"** 证书（不是 "Apple Development"）

4. **重新 Archive 并运行修复脚本**

---

### 方法 3：移除 Sparkle（最简单）

如果只通过 App Store 分发，最简单的方法是移除 Sparkle：

1. **在 Xcode 中移除 Sparkle 框架**
   - 选择项目 → **CiteTrack** target → **General**
   - 在 **Frameworks, Libraries, and Embedded Content** 中
   - 删除 Sparkle.framework

2. **重新 Archive 和提交**

---

## 🔍 验证修复是否成功

运行修复脚本后，验证签名：

```bash
# 找到 Archive 路径
ARCHIVE_PATH="/Users/tao.shen/Library/Developer/Xcode/Archives/最新日期/CiteTrack*.xcarchive"

# 检查 Autoupdate 的签名信息
codesign -dvv "$ARCHIVE_PATH/Products/Applications/CiteTrack.app/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate" 2>&1 | grep -E "Authority|TeamIdentifier"
```

应该看到正确的签名身份（不是 "Apple" 或 "-"）。

---

## 📝 关于 dSYM 警告

dSYM 警告是**正常的**，不会阻止提交：
- Sparkle 是第三方框架，没有源代码
- 无法生成 dSYM 文件
- App Store 通常会接受这些警告

如果必须解决，可以从 Sparkle 官方获取 dSYM：
- https://github.com/sparkle-project/Sparkle/releases

---

## 🆘 如果仍然失败

请提供以下信息：
1. 修复脚本的完整输出
2. Archive 的创建时间
3. 是否在运行脚本后才点击 "Distribute App"
4. 使用的签名证书类型（Developer ID 还是 Apple Development）

---

## 💡 最佳实践

1. **每次 Archive 后立即运行修复脚本**
2. **在脚本输出确认成功后再提交**
3. **如果多次失败，考虑移除 Sparkle**

