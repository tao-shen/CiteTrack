# ⚠️ 重要：修复脚本使用说明

## 🔴 关键问题

即使修复脚本成功运行，如果操作顺序不正确，App Store 验证仍然会失败。

## ✅ 正确的操作顺序

### 步骤 1：Archive 构建

1. 在 Xcode 中：**Product → Archive**
2. **等待 Archive 完成**
3. **不要立即点击 "Distribute App"**

### 步骤 2：运行修复脚本（关键！）

Archive 完成后，**在 Xcode Organizer 中点击 "Distribute App" 之前**，先运行修复脚本：

```bash
cd /Users/tao.shen/google_scholar_plugin/macOS
./scripts/fix_archive_entitlements.sh
```

**重要**：脚本会修改 Archive 中的文件，确保所有 Sparkle 组件都有正确的 entitlements。

### 步骤 3：验证修复

运行脚本后，检查输出。应该看到：
```
✅ Autoupdate signed and verified
✅ Updater executable signed and verified
✅ Updater.app bundle signed and verified
✅ Downloader executable signed and verified
✅ Downloader.xpc bundle signed and verified
✅ Installer executable signed and verified
✅ Installer.xpc bundle signed and verified
✅ Sparkle framework components signing complete!
```

### 步骤 4：在 Xcode Organizer 中提交

1. **刷新 Organizer**（关闭并重新打开，或按 Cmd+R）
2. 选择修复后的 Archive
3. 点击 **Distribute App**
4. 选择 **App Store Connect**
5. 完成上传

---

## ⚠️ 常见错误

### 错误 1：先点击 "Distribute App" 再运行脚本

**错误操作**：
1. Archive 完成
2. 立即点击 "Distribute App" ❌
3. 然后运行修复脚本 ❌

**正确操作**：
1. Archive 完成
2. **先运行修复脚本** ✅
3. 然后点击 "Distribute App" ✅

### 错误 2：使用旧的 Archive

如果 Archive 已经提交过，需要：
1. 重新 Archive
2. 运行修复脚本
3. 再提交

---

## 🔍 如何确认修复成功

运行修复脚本后，验证签名：

```bash
# 找到 Archive 路径（脚本会显示）
ARCHIVE_PATH="/Users/tao.shen/Library/Developer/Xcode/Archives/2025-11-23/CiteTrack 2025-11-23, 23.41.xcarchive"

# 检查 Autoupdate 的 entitlements
codesign -d --entitlements /tmp/check.plist "$ARCHIVE_PATH/Products/Applications/CiteTrack.app/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate" 2>&1
cat /tmp/check.plist | grep -A 1 "app-sandbox"
```

应该看到：
```xml
<key>com.apple.security.app-sandbox</key>
<true/>
```

---

## 📝 完整操作流程

```bash
# 1. 在 Xcode 中 Archive
# Product → Archive

# 2. Archive 完成后，运行修复脚本
cd /Users/tao.shen/google_scholar_plugin/macOS
./scripts/fix_archive_entitlements.sh

# 3. 检查输出，确认所有组件都已签名

# 4. 在 Xcode Organizer 中提交
# Window → Organizer → 选择 Archive → Distribute App
```

---

## 🆘 如果仍然失败

如果按照上述步骤操作后仍然失败，请：

1. **检查 Archive 路径**：确保脚本修改的是正确的 Archive
2. **重新 Archive**：删除旧的 Archive，重新构建
3. **检查签名身份**：确保使用正确的开发者证书
4. **考虑移除 Sparkle**：如果只通过 App Store 分发，移除 Sparkle 是最简单的解决方案

---

## 💡 提示

- 修复脚本会**直接修改 Archive 文件**，所以运行后不需要重新 Archive
- 但如果在运行脚本**之前**已经点击了 "Distribute App"，需要重新 Archive
- 建议在 Archive 完成后**立即**运行修复脚本，然后再提交

